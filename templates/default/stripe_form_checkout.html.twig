{#
/**
 * Copyright Â© 2003-2025 The Galette Team
 *
 * This file is part of Galette Stripe plugin (https://galette-community.github.io/plugin-stripe).
 *
 * Galette is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Galette is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Galette. If not, see <http://www.gnu.org/licenses/>.
 */
#}
{% extends not login.isLogged() ? "public_page.html.twig" : "page.html.twig" %}

{% block content %}
    <form action="" method="post" id="payment-form" class="ui form">
        <div class="ui segment">
            <div class="ui inverted secondary big segment">
                <div class="ui large center aligned header">
                    {% set charged_amount = stripe.isZeroDecimal(stripe.getCurrency()) ? amount : amount / 100.0 %}
                    {{ charged_amount|format_currency(stripe.getCurrency(), {}, galette_lang) }}
                    <div class="sub header">{{ item_name }}</div>
                </div>
            </div>
            <div id="billing-details" class="ui two column stackable grid basic fitted segment">
                <div class="column">
                    <h2 class="ui horizontal left aligned divider tiny header">
                        <i class="address card outline icon"></i>
                        {{ _T("Billing details", "stripe") }}
                    </h2>
                    {% if metadata %}
                        <strong>{{ metadata.billing_name|e }}</strong><br>
                        {% if metadata.billing_company != '' %}
                            {{ metadata.billing_company|e }}<br>
                        {% endif %}
                        {% if metadata.billing_address != '' %}
                            {{ metadata.billing_address|e }}<br>
                        {% endif %}
                        {% if metadata.billing_zip != '' %}
                            {{ metadata.billing_zip|e }}
                        {% endif %}
                        {% if metadata.billing_town != '' %}
                            {{ metadata.billing_town|e }}<br>
                        {% endif %}
                        {% if metadata.billing_country != '' %}
                            {{ metadata.billing_country|e }}
                        {% endif %}
                        {{ metadata.billing_email|e }}
                    {% endif %}
                </div>
                <div class="column">
                    <h2 class="ui horizontal left aligned divider tiny header">
                        <i class="credit card outline icon"></i>
                        {{ _T("Payment details", "stripe") }}
                    </h2>
                    <div id="error"></div>
                    <div class="field">
                        <label for="stripe-card-number" data-tid="elements.form.card_number_label">{{ _T("Card number", "stripe") }}</label>
                        <div id="stripe-card-number" class="input empty"></div>
                    </div>
                    <div class="field">
                        <label for="stripe-card-expiry" data-tid="elements.form.card_expiry_label">{{ _T("Expiration", "stripe") }}</label>
                        <div id="stripe-card-expiry" class="input empty"></div>
                    </div>
                    <div class="field">
                        <label for="stripe-card-cvc" data-tid="elements.form.card_cvc_label">{{ _T("CVC", "stripe") }}</label>
                        <div id="stripe-card-cvc" class="input empty"></div>
                    </div>
                    <div class="field">
                        <button type="submit" data-tid="elements.form.pay_button" class="ui primary fluid large button action">
                            {{ _T("Pay", "stripe") }}
                        </button>
                    </div>
                </div>
            </div>
            <div id="success"></div>
        </div>
    </form>
{% endblock %}

{% block javascripts %}
    {% if stripe.isLoaded() and stripe.getPubKey() != null and stripe.getPrivKey() != null %}
        <script src="https://js.stripe.com/v3/" defer></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('payment-form');
                const errorContainer = document.getElementById('error');
                const errorMessage = '<div class="ui icon visible negative center aligned message"><div class="content"></div></div>';
                const successContainer = document.getElementById('success');
                const successMessage = '<div class="ui icon visible positive center aligned message"><div class="header"></div></div>';
                const elementStyles = {
                    base: {
                        color: '#32325D',
                        fontWeight: 500,
                        fontFamily: 'Source Code Pro, Consolas, Menlo, monospace',
                        fontSize: '16px',
                        fontSmoothing: 'antialiased',

                        '::placeholder': {
                            color: '#CFD7DF',
                        },
                        ':-webkit-autofill': {
                            color: '#e39f48',
                        },
                    },
                    invalid: {
                        color: '#E25950',

                        '::placeholder': {
                            color: '#FFCCA5',
                        },
                    },
                };
                const elementClasses = {
                    focus: 'focused',
                    empty: 'empty',
                    invalid: 'invalid',
                };

                let stripe = Stripe('{{ stripe.getPubKey() }}', {});

                // Create the form from Stripe Elements
                let elements = stripe.elements();

                let cardNumber = elements.create('cardNumber', {
                    style: elementStyles,
                    classes: elementClasses,
                });
                cardNumber.mount('#stripe-card-number');

                let cardExpiry = elements.create('cardExpiry', {
                    style: elementStyles,
                    classes: elementClasses,
                });
                cardExpiry.mount('#stripe-card-expiry');

                let cardCvc = elements.create('cardCvc', {
                    style: elementStyles,
                    classes: elementClasses,
                });
                cardCvc.mount('#stripe-card-cvc');

                // Create the payment request
                let paymentRequest = stripe.paymentRequest({
                    country: '{{ stripe.getCountry() }}',
                    currency: '{{ stripe.getCurrency() }}',
                    total: {
                        label: '{{ item_name }}',
                        amount: {{ amount }},
                    },
                    requestPayerName: true,
                    requestPayerEmail: true,
                });

                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.classList.add('loading');

                    const paymentData = {
                        payment_method: {
                            card: cardNumber,
                            billing_details: {
                                name: '{{ metadata.billing_name|e("js") }}',
                                email: '{{ metadata.billing_email|e("js") }}'
                            }
                        }
                    };

                    stripe.confirmCardPayment('{{ client_secret }}', paymentData).then(function(result) {
                        if (result.error) {
                            errorContainer.innerHTML= '';
                            errorContainer.insertAdjacentHTML('afterbegin', errorMessage);
                            errorContainer.children['0'].innerHTML = result.error.message;
                            submitButton.disabled = false;
                            submitButton.classList.remove('loading');
                        } else if (result.paymentIntent.status === 'succeeded') {
                            successContainer.innerHTML= '';
                            successContainer.insertAdjacentHTML('afterbegin', successMessage);
                            successContainer.children['0'].innerHTML = '{{ _T("Your payment was successful. You may receive a mail from Stripe with details.", "stripe") }}';
                            document.getElementById('billing-details').remove();
                        }
                    });
                });
            });
        </script>
    {% endif %}
{% endblock %}
